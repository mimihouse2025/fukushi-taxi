<!-- 修正済み完全HTMLコード -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>福祉タクシー利用料</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1Y1geobXRlk517MSj_b3dEl9o1wZjKSs&libraries=places" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, select, button { width: 100%; padding: 8px; margin: 10px 0; box-sizing: border-box; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    .radio-group { margin-bottom: 15px; }
    .radio-group label { font-weight: normal; margin-left: 20px; display: inline-block; }
    #result, #details, #breakdown { margin-top: 20px; font-weight: bold; }
    #breakdown ul { padding-left: 20px; }
    #invoice { font-size: 14px; page-break-inside: avoid; }
    .invoice-block { border: 1px solid #000; padding: 10px; margin-bottom: 20px; }
    .invoice-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .invoice-title { font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 10px; }
    .invoice-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .invoice-table th, .invoice-table td { border: 1px solid #000; padding: 6px; text-align: left; }
  </style>
</head>
<body>
<!-- 中略：フォームとボタン部分は既存のまま -->

<script>
let distanceKmGlobal = 0;

function calculateFare() {
  const origin = document.getElementById("origin").value;
  const destination = document.getElementById("destination").value;
  const waypoint1 = document.getElementById("waypoint1").value;
  const waypoint2 = document.getElementById("waypoint2").value;
  const waypoint3 = document.getElementById("waypoint3").value;
  const timeStr = document.getElementById("rideTime").value;
  const [hour] = timeStr.split(":" ).map(Number);
  const isNight = (hour >= 22 || hour < 5);

  const waypoints = [waypoint1, waypoint2, waypoint3].map(val => val.trim()).filter(Boolean).map(val => ({ location: val, stopover: true }));

  const service = new google.maps.DirectionsService();
  service.route({ origin, destination, waypoints, travelMode: google.maps.TravelMode.DRIVING }, function(response, status) {
    if (status !== 'OK') {
      document.getElementById("result").innerHTML = "ルート取得失敗：" + status;
      return;
    }

    let totalMeters = 0;
    response.routes[0].legs.forEach(leg => totalMeters += leg.distance.value);
    const distanceKm = totalMeters / 1000;
    distanceKmGlobal = distanceKm;

    let fare = 341;
    let breakdown = [
      `出発地：${origin}`,
      ...waypoints.map((wp, i) => `経由地${i + 1}：${wp.location}`),
      `目的地：${destination}`,
      "距離基本運賃：¥341"
    ];

    if (distanceKm > 1) {
      const addFare = Math.ceil(distanceKm - 1) * 330;
      fare += addFare;
      breakdown.push(`追加距離：¥${addFare}`);
    }
    if (isNight) {
      fare = Math.round(fare * 1.2);
      breakdown.push("深夜割増：×1.2");
    }
    fare += 400;
    breakdown.push("予約料：¥400");

    const boardingAssist = document.querySelector('input[name="boardingAssist"]:checked').value;
    if (boardingAssist === "yes") {
      fare += 1100;
      breakdown.push("乗降介助：¥1100");
    }

    const indoor = parseInt(document.getElementById("indoorAssistants").value) || 0;
    fare += indoor * 1100;
    breakdown.push(`室内移動付乗降介助：¥${indoor * 1100}`);

    const assistUnit = parseFloat(document.getElementById("assistantHours").value) || 0;
    const nurses = parseInt(document.getElementById("nurseAssistants").value) || 0;
    const helpers = parseInt(document.getElementById("helperAssistants").value) || 0;
    let assistFare = (nurses * 3000 + helpers * 1250) * (assistUnit * 2);
    if (isNight) assistFare = Math.round(assistFare * 1.2);
    fare += assistFare;
    breakdown.push(`看護師・ヘルパー付添い：¥${assistFare}`);

    const stairs = document.querySelector('input[name="stairsSupport"]:checked').value;
    if (stairs === "yes") {
      const stairFare = 2200 + 2 * (helpers > 0 ? 1250 * (assistUnit * 2) : 0);
      fare += stairFare;
      breakdown.push(`階段昇降介助：¥${stairFare}`);
    }

    const stretcher = document.querySelector('input[name="stretcher"]:checked').value;
    if (stretcher === "yes") {
      fare += 4000;
      breakdown.push("ストレッチャー使用料：¥4000");
    }

    const wheelchair = document.querySelector('input[name="wheelchair"]:checked').value;
    if (wheelchair === "yes") breakdown.push("貸し出し車椅子：¥0");

    document.getElementById("result").innerHTML = `合計運賃：¥${fare.toLocaleString()}（${isNight ? "深夜料金適用" : "通常料金"}）`;
    document.getElementById("details").innerHTML = `距離：${distanceKm.toFixed(2)} km`;
    document.getElementById("breakdown").innerHTML = `<h4>内訳</h4><ul><li>${breakdown.join('</li><li>')}</li></ul>`;
  });
}

function generatePDF() {
  const breakdownList = document.querySelector('#breakdown ul');
  if (!breakdownList) {
    alert('先に「運賃を計算する」を実行してください。');
    return;
  }
  const tableHTML = Array.from(breakdownList.children).map(item => `<tr><td>${item.innerText}</td></tr>`).join('');
  const distanceRow = `<tr><td><strong>走行距離：${distanceKmGlobal.toFixed(2)} km</strong></td></tr>`;
  const finalRow = `<tr><td><strong>` + document.getElementById("result").innerText + `</strong></td></tr>`;
  const fullTable = `<tr><th>内訳明細</th></tr>` + tableHTML + distanceRow + finalRow;

  document.getElementById("invoice-table").innerHTML = fullTable;
  document.getElementById("invoice-table-copy").innerHTML = fullTable;

  const element = document.getElementById("invoice");
  element.style.display = "block";
  html2pdf().set({
    margin: 10,
    filename: '福祉タクシー請求書_領収書.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  }).from(element).save().then(() => {
    element.style.display = "none";
  });
}
</script>
</body>
</html>
